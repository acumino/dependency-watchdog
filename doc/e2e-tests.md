# End to End tests

## Table Of Contents
- [End to End tests](#end-to-end-tests)
  - [Table Of Contents](#table-of-contents)
  - [DWD prober](#dwd-prober)
    - [Setup](#setup)
    - [Tests Performed](#tests-performed)


## DWD prober

### Setup 
We create a `shooted seed` setup using [Gardener-The Hard Way](https://pages.github.tools.sap/kubernetes/onboarding-website/setup/localsetup/hardlocalsetup/) and deploy a local shoot in our shooted seed. After the shoot is deployed, we `annotate` the `managed resource` for DWD prober present in the `garden` namespace of the seed worker plane with the following:
```yaml
resources.gardener.cloud/ignore: "true"
```
Now we `scale down` the DWD prober deployment in the garden namespace and run it locally out of cluster by providing the prober config and the kubeconfig of the shooted seed as command line flags. 

For these tests, both the probes use the same target url mentioned in the dns record `$SHOOTNAME-internal`. External probe already uses this but the internal probe uses in-cluster DNS which will cause it to fail, so to handle that we change the `internal kubeconfig secret` to use the same targt url as external probe.

### Tests Performed

| test                                                                                                                                                                                                                       | result                                                                                                                                                                                                                                                                                                                               |
| :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| scale down kcm and mcm                                                                                                                                                                                                     | both probes pass and are healthy, scaling up operation starts, `CA` is skipped as replica count matches the desired value, first `KCM` is scaled up and then `MCM`                                                                                                                                                                   |
| update the internal probe secret by changing the server url so that it fails                                                                                                                                               | internal probe fails, external probe and any scaling of dependent resources is not done                                                                                                                                                                                                                                              |
| internal probe is failing, change the secret back so that it succeeds                                                                                                                                                      | both the probes pass and scaling up happens according to the flow (skipped if replicas already match)                                                                                                                                                                                                                                |
| hibernate the cluster when the probe is `SleepWithContext` due to the `initialDelay` before scaling the resource                                                                                                           | the prober is removed when hibernation is enabled and the `Cancelled Context` error is logged                                                                                                                                                                                                                                        |
| wake up the cluster from hibernation                                                                                                                                                                                       | new prober is added for the cluster only after the wake up process is complete                                                                                                                                                                                                                                                       |
| update the external probe secret to use an incorrect server url so that it fails                                                                                                                                           | external probe fails, after 3 tries(failure threshold) it becomes unhealthy and starts scaling down of resources, first `KCM` and `MCM` are brought down in parallel and then `CA`                                                                                                                                                   |
| external probe is unhealthy, revert back to the original external probe secret so that it succeeds                                                                                                                         | Both the probes pass, both are healthy after 1 try(success threshold) and scaling up begins, first `CA` is scaled up, then `KCM` and then `MCM`                                                                                                                                                                                      |
| external probe is unhealthy, revert back to the original external probe secret and change the internal probe secret to use the wrong server url                                                                            | internal probe fails, external probe and any scaling of dependent resources is not done                                                                                                                                                                                                                                              |
| set annotation `dependency-watchdog.gardener.cloud/ignore-scaling: true` one by one on `CA`, `KCM`, and `MCM` deployment. Do this for both the cases - external probe success and failure                                  | In both the cases, the expected scaling operation is performed and the annotated deployment is not scaled. The other deployments are scaled as expected                                                                                                                                                                              |
| set annotation `dependency-watchdog.gardener.cloud/ignore-scaling: true` on `KCM` deployment, scale `KCM` and `MCM` down, let the probes succeed, when `MCM` tries to scale up remove the annotation from `KCM` deployment | Both probes pass and are healthy. In the first run, `KCM` is not scaled because of the annotation being set, `MCM` is not scaled because now the annotation from `KCM` is removed and it is not scaled to desired replicas. When the probes are done for the second time, they succeed and scaling up of `KCM` and then `MCM` occurs |
| Scale down the apiserver deployment                                                                                                                                                                                        | Internal probe fails, external probe and any scaling of dependent resources is not done                                                                                                                                                                                                                                              |
| Remove `KCM` deployment before - 1. It tries to scale it up. 2. It tries to scale it down                                                                                                                                  | The flow is stopped at scaling KCM, the retry errors and the final error that "`KCM` is not found" is logged and no further scaling happens in this run of prober. For scaleUp, `CA` is scaled up but `MCM` is not. For scaleDown, `MCM` is scaled down as it is a parallel operation but `CA` is not                                |
| Remove `KCM` deployment just before `MCM` tries to scaleUp                                                                                                                                                                 | Two cases are possible - 1. If the `MCM` deployment is already matching desired replicas, then no error is recorded in this run and scaling is skipped, but if it does not then "`KCM` deployment not found" error is logged and scaling is skipped.                                                                                 |
| Remove `MCM` deployment just before `CA` is scaled down                                                                                                                                                                    | Two cases are possible - 1. If the `CA` deployment is already matching desired replicas, then no error is recorded in this run and scaling is skipped, but if it does not then "`MCM` deployment not found" error is logged and scaling is skipped.                                                                                  |
| Change the `token` in the internal kubeconfig secret to get an ignorable error from internal probe.                                                                                                                        | The previous state of the probe status is maintained and further action of doing the external probe or not is done based on that.                                                                                                                                                                                                    |
| Change the `token` of the external kubeconfig secret to get an ignorable error from external probe                                                                                                                         | The previous state of the probe status is maintained and further action of scaling resources is done based on that.                                                                                                                                                                                                                  |
| Delete the shoot from the local garden cluster                                                                                                                                                                             | The prober is removed when the deletion is enabled and gardenlet starts the process of deleting the shoot.                                                                                                                                                                                                                           |
